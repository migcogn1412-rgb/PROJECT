/*
 * PROJECT: QUAN LY QUAN CA PHE (Full Features)
 * Environment: Visual Studio (C++20 Standard)
 * Author: Student
 */

#include <iostream>
#include <string>
#include <format> // Yeu cau C++20
#include <fstream>
#include <sstream>
#include <ctime>

using namespace std;

const int TOI_DA = 100;

// =========================================================
// 1. KHAI BÁO STRUCT
// =========================================================
struct DoUong {
	string ten, loai, ma;
	int giaGoc = 0;
};

struct DoAn {
	string ten, loai, ma;
	int giaGoc = 0;
};

struct Topping {
	string ten, ma;
	int giaGoc = 0;
};

struct CauHinh {
	string size;
	int giaCongThem = 0;
};

struct Ban {
	int soBan = 0;
	int trangThai = 0; // 0: Trong, 1: Co khach
};

struct ChiTietMon {
	string maMon, tenMon;
	int giaGoc = 0;
	string size = "S"; int giaSize = 0;
	string topping = "", maTopping = ""; int giaTopping = 0;
	int duong = 100, da = 100;
	int soLuong = 0;
	int thanhTien = 0;
};

struct HoaDon {
	string maHD, ngay;
	int soBan = 0;
	ChiTietMon dsMon[TOI_DA];
	int soMon = 0;
	long long tongTien = 0;
	string ghiChu = "";
};

struct MonMenu { // Struct tam de gop menu Order
	string ma, ten, loai;
	int gia = 0;
};

// =========================================================
// 2. HÀM TIỆN ÍCH CHUNG
// =========================================================
void veDuong(int doDai) {
	cout << string(doDai, '-') << endl;
}

void veTieuDe(string tieuDe) {
	cout << endl;
	veDuong(60);
	cout << format("|-{:^56}-|", tieuDe) << endl;
	veDuong(60);
	cout << endl;
}

void dungManHinh() {
	cout << endl << "--> Nhan [ENTER] de quay lai...";
	string rac;
	getline(cin, rac);
}

bool xacNhan() {
	string xacNhan;
	cout << " [*] XAC NHAN (Y/N): ";
	getline(cin, xacNhan);
	if (xacNhan == "Y" || xacNhan == "y") return true;
	return false;
}

string layNgayHienTai() {
	time_t bayGio = time(0);
	tm ltm;
	localtime_s(&ltm, &bayGio);
	return format("{:02}/{:02}/{}", ltm.tm_mday, 1 + ltm.tm_mon, 1900 + ltm.tm_year);
}

// Ham tach chuoi de doc file (Quan trong cho Thong ke)
string tachData(string str, int index) {
	istringstream ss(str); string segment;
	int i = 0;
	while (getline(ss, segment, '|')) {
		if (i == index) return segment;
		i++;
	}
	return "";
}

// =========================================================
// 3. QUẢN LÝ ĐỒ UỐNG (DOC/GHI/THEM/XOA/SUA)
// =========================================================
DoUong docDoUong(string thongTin) {
	istringstream phanTach(thongTin);
	DoUong d; string boNhoDem;
	getline(phanTach, d.ten, '|');
	getline(phanTach, boNhoDem, '|'); d.giaGoc = stoi(boNhoDem);
	getline(phanTach, d.loai, '|'); getline(phanTach, d.ma);
	return d;
}
bool docFileDoUong(string tenFile, DoUong danhSach[], int& thuTu) {
	ifstream docFile(tenFile, ios::in);
	if (!docFile.is_open()) return false;
	string boNhoDem; thuTu = 0;
	while (getline(docFile, boNhoDem)) {
		if (boNhoDem.length() > 5) {
			danhSach[thuTu] = docDoUong(boNhoDem);
			if (danhSach[thuTu].ma != "") thuTu++;
		}
	}
	docFile.close(); return true;
}
bool ghiFileDoUong(string tenFile, DoUong danhSach[], int& thuTu) {
	ofstream ghiFile(tenFile, ios::out);
	if (!ghiFile.is_open()) return false;
	for (int i = 0; i < thuTu; i++) {
		ghiFile << danhSach[i].ten << "|" << danhSach[i].giaGoc << "|"
			<< danhSach[i].loai << "|" << danhSach[i].ma << endl;
	}
	ghiFile.close(); return true;
}
void inMenuDoUong(DoUong danhSach[], int& thuTu) {
	veDuong(73);
	cout << format("| {:<10} | {:<30} | {:<10} | {:<10} |", "MA", "TEN DO UONG", "GIA", "LOAI") << endl;
	veDuong(73);
	for (int i = 0; i < thuTu; i++) {
		cout << format("| {:<10} | {:<30} | {:<10} | {:<10} |", danhSach[i].ma, danhSach[i].ten, danhSach[i].giaGoc, danhSach[i].loai) << endl;
	}
	veDuong(73); cout << endl;
}
void themDoUong(string fileDoUong) {
	veTieuDe("THEM DO UONG MOI");
	DoUong danhSach[TOI_DA]; int thuTu = 0;
	if (docFileDoUong(fileDoUong, danhSach, thuTu)) inMenuDoUong(danhSach, thuTu);

	DoUong moi;
	cout << format("{:<25}: ", "Nhap ma do uong"); getline(cin, moi.ma);
	cout << format("{:<25}: ", "Nhap ten do uong"); getline(cin, moi.ten);
	cout << format("{:<25}: ", "Nhap gia goc"); string s; getline(cin, s); moi.giaGoc = (s == "") ? 0 : stoi(s);
	cout << format("{:<25}: ", "Nhap loai"); getline(cin, moi.loai);

	if (xacNhan()) {
		ofstream them(fileDoUong, ios::app);
		them << moi.ten << "|" << moi.giaGoc << "|" << moi.loai << "|" << moi.ma << endl;
		them.close();
		cout << "\n--> [THANH CONG] Da them!\n";
	}
}
void xoaDoUong(string fileDoUong) {
	veTieuDe("XOA DO UONG");
	DoUong danhSach[TOI_DA]; int thuTu = 0;
	docFileDoUong(fileDoUong, danhSach, thuTu);
	inMenuDoUong(danhSach, thuTu);

	cout << "Nhap MA do uong muon xoa: "; string ma; getline(cin, ma);
	bool found = false;
	for (int i = 0; i < thuTu; i++) {
		if (danhSach[i].ma == ma) {
			found = true;
			if (xacNhan()) {
				for (int j = i; j < thuTu - 1; j++) danhSach[j] = danhSach[j + 1];
				thuTu--;
				ghiFileDoUong(fileDoUong, danhSach, thuTu);
				cout << "\n--> [THANH CONG] Da xoa!\n";
			}
			break;
		}
	}
	if (!found) cout << "\n--> Khong tim thay ma!\n";
}
void suaDoUong(string fileDoUong) {
	veTieuDe("SUA DO UONG");
	DoUong danhSach[TOI_DA]; int thuTu = 0;
	docFileDoUong(fileDoUong, danhSach, thuTu);
	inMenuDoUong(danhSach, thuTu);

	cout << "Nhap MA do uong muon sua: "; string ma; getline(cin, ma);
	for (int i = 0; i < thuTu; i++) {
		if (danhSach[i].ma == ma) {
			string buf;
			cout << format("Ten moi (cu: {}): ", danhSach[i].ten); getline(cin, buf);
			if (buf != "") danhSach[i].ten = buf;
			
			cout << format("Gia moi (cu: {}): ", danhSach[i].giaGoc); getline(cin, buf);
			if (buf != "") danhSach[i].giaGoc = stoi(buf);

			cout << format("Loai moi (cu: {}): ", danhSach[i].loai); getline(cin, buf);
			if (buf != "") danhSach[i].loai = buf;

			if (xacNhan()) {
				ghiFileDoUong(fileDoUong, danhSach, thuTu);
				cout << "\n--> [THANH CONG] Da cap nhat!\n";
			}
			return;
		}
	}
	cout << "\n--> Khong tim thay ma!\n";
}
void quanLiDoUong() {
	while (true) {
		system("cls"); veTieuDe("[I] QUAN LI DO UONG");
		cout << "[1] Them\n[2] Xoa\n[3] Sua\n[0] Quay lai\n";
		veDuong(60); cout << " [*] CHON: ";
		string s; getline(cin, s); int c = (s == "") ? 0 : stoi(s);
		if (c == 0) break;
		system("cls");
		if (c == 1) themDoUong("DoUong.txt");
		else if (c == 2) xoaDoUong("DoUong.txt");
		else if (c == 3) suaDoUong("DoUong.txt");
		dungManHinh();
	}
}

// =========================================================
// 4. QUẢN LÝ ĐỒ ĂN (DOC/GHI/THEM/XOA/SUA)
// =========================================================
DoAn docDoAn(string thongTin) {
	istringstream phanTach(thongTin);
	DoAn d; string boNhoDem;
	getline(phanTach, d.ten, '|');
	getline(phanTach, boNhoDem, '|'); d.giaGoc = stoi(boNhoDem);
	getline(phanTach, d.loai, '|'); getline(phanTach, d.ma);
	return d;
}
bool docFileDoAn(string tenFile, DoAn danhSach[], int& thuTu) {
	ifstream docFile(tenFile, ios::in);
	if (!docFile.is_open()) return false;
	string boNhoDem; thuTu = 0;
	while (getline(docFile, boNhoDem)) {
		if (boNhoDem.length() > 5) {
			danhSach[thuTu] = docDoAn(boNhoDem);
			if (danhSach[thuTu].ma != "") thuTu++;
		}
	}
	docFile.close(); return true;
}
bool ghiFileDoAn(string tenFile, DoAn danhSach[], int& thuTu) {
	ofstream ghiFile(tenFile, ios::out);
	if (!ghiFile.is_open()) return false;
	for (int i = 0; i < thuTu; i++) {
		ghiFile << danhSach[i].ten << "|" << danhSach[i].giaGoc << "|"
			<< danhSach[i].loai << "|" << danhSach[i].ma << endl;
	}
	ghiFile.close(); return true;
}
void inMenuDoAn(DoAn danhSach[], int& thuTu) {
	veDuong(73);
	cout << format("| {:<10} | {:<30} | {:<10} | {:<10} |", "MA", "TEN DO AN", "GIA", "LOAI") << endl;
	veDuong(73);
	for (int i = 0; i < thuTu; i++) {
		cout << format("| {:<10} | {:<30} | {:<10} | {:<10} |", danhSach[i].ma, danhSach[i].ten, danhSach[i].giaGoc, danhSach[i].loai) << endl;
	}
	veDuong(73); cout << endl;
}
void themDoAn(string fileDoAn) {
	veTieuDe("THEM DO AN MOI");
	DoAn danhSach[TOI_DA]; int thuTu = 0;
	if (docFileDoAn(fileDoAn, danhSach, thuTu)) inMenuDoAn(danhSach, thuTu);

	DoAn moi;
	cout << format("{:<25}: ", "Nhap ma do an"); getline(cin, moi.ma);
	cout << format("{:<25}: ", "Nhap ten do an"); getline(cin, moi.ten);
	cout << format("{:<25}: ", "Nhap gia goc"); string s; getline(cin, s); moi.giaGoc = (s == "") ? 0 : stoi(s);
	cout << format("{:<25}: ", "Nhap loai"); getline(cin, moi.loai);

	if (xacNhan()) {
		ofstream them(fileDoAn, ios::app);
		them << moi.ten << "|" << moi.giaGoc << "|" << moi.loai << "|" << moi.ma << endl;
		them.close(); cout << "\n--> [THANH CONG] Da them!\n";
	}
}
void xoaDoAn(string fileDoAn) {
	veTieuDe("XOA DO AN");
	DoAn danhSach[TOI_DA]; int thuTu = 0;
	docFileDoAn(fileDoAn, danhSach, thuTu); inMenuDoAn(danhSach, thuTu);

	cout << "Nhap MA do an muon xoa: "; string ma; getline(cin, ma);
	for (int i = 0; i < thuTu; i++) {
		if (danhSach[i].ma == ma) {
			if (xacNhan()) {
				for (int j = i; j < thuTu - 1; j++) danhSach[j] = danhSach[j + 1];
				thuTu--; ghiFileDoAn(fileDoAn, danhSach, thuTu);
				cout << "\n--> [THANH CONG] Da xoa!\n";
			}
			return;
		}
	}
	cout << "\n--> Khong tim thay ma!\n";
}
void suaDoAn(string fileDoAn) {
	veTieuDe("SUA DO AN");
	DoAn danhSach[TOI_DA]; int thuTu = 0;
	docFileDoAn(fileDoAn, danhSach, thuTu); inMenuDoAn(danhSach, thuTu);

	cout << "Nhap MA do an muon sua: "; string ma; getline(cin, ma);
	for (int i = 0; i < thuTu; i++) {
		if (danhSach[i].ma == ma) {
			string buf;
			cout << format("Ten moi (cu: {}): ", danhSach[i].ten); getline(cin, buf); if (buf != "") danhSach[i].ten = buf;
			cout << format("Gia moi (cu: {}): ", danhSach[i].giaGoc); getline(cin, buf); if (buf != "") danhSach[i].giaGoc = stoi(buf);
			if (xacNhan()) {
				ghiFileDoAn(fileDoAn, danhSach, thuTu); cout << "\n--> [THANH CONG] Da cap nhat!\n";
			}
			return;
		}
	}
	cout << "\n--> Khong tim thay ma!\n";
}
void quanLiDoAn() {
	while (true) {
		system("cls"); veTieuDe("[II] QUAN LI DO AN");
		cout << "[1] Them\n[2] Xoa\n[3] Sua\n[0] Quay lai\n";
		veDuong(60); cout << " [*] CHON: ";
		string s; getline(cin, s); int c = (s == "") ? 0 : stoi(s);
		if (c == 0) break;
		system("cls");
		if (c == 1) themDoAn("DoAn.txt"); else if (c == 2) xoaDoAn("DoAn.txt"); else if (c == 3) suaDoAn("DoAn.txt");
		dungManHinh();
	}
}

// =========================================================
// 5. QUẢN LÝ TOPPING (DOC/GHI/THEM/XOA/SUA)
// =========================================================
Topping docTopping(string thongTin) {
	istringstream phanTach(thongTin);
	Topping t; string boNhoDem;
	getline(phanTach, t.ten, '|');
	getline(phanTach, boNhoDem, '|'); t.giaGoc = stoi(boNhoDem);
	getline(phanTach, t.ma); return t;
}
bool docFileTopping(string tenFile, Topping danhSach[], int& thuTu) {
	ifstream docFile(tenFile, ios::in);
	if (!docFile.is_open()) return false;
	string boNhoDem; thuTu = 0;
	while (getline(docFile, boNhoDem)) {
		if (boNhoDem.length() > 5) {
			danhSach[thuTu] = docTopping(boNhoDem);
			if (danhSach[thuTu].ma != "") thuTu++;
		}
	}
	docFile.close(); return true;
}
bool ghiFileTopping(string tenFile, Topping danhSach[], int& thuTu) {
	ofstream ghiFile(tenFile, ios::out);
	if (!ghiFile.is_open()) return false;
	for (int i = 0; i < thuTu; i++) {
		ghiFile << danhSach[i].ten << "|" << danhSach[i].giaGoc << "|" << danhSach[i].ma << endl;
	}
	ghiFile.close(); return true;
}
void inMenuTopping(Topping danhSach[], int& thuTu) {
	veDuong(60);
	cout << format("| {:<10} | {:<30} | {:<10} |", "MA", "TEN TOPPING", "GIA") << endl;
	veDuong(60);
	for (int i = 0; i < thuTu; i++) {
		cout << format("| {:<10} | {:<30} | {:<10} |", danhSach[i].ma, danhSach[i].ten, danhSach[i].giaGoc) << endl;
	}
	veDuong(60); cout << endl;
}
void themTopping(string fileTopping) {
	veTieuDe("THEM TOPPING MOI");
	Topping danhSach[TOI_DA]; int thuTu = 0;
	docFileTopping(fileTopping, danhSach, thuTu); inMenuTopping(danhSach, thuTu);
	Topping moi;
	cout << format("{:<25}: ", "Nhap ma topping"); getline(cin, moi.ma);
	cout << format("{:<25}: ", "Nhap ten topping"); getline(cin, moi.ten);
	cout << format("{:<25}: ", "Nhap gia goc"); string s; getline(cin, s); moi.giaGoc = (s == "") ? 0 : stoi(s);
	if (xacNhan()) {
		ofstream them(fileTopping, ios::app);
		them << moi.ten << "|" << moi.giaGoc << "|" << moi.ma << endl;
		them.close(); cout << "\n--> [THANH CONG] Da them!\n";
	}
}
void xoaTopping(string fileTopping) {
	veTieuDe("XOA TOPPING");
	Topping danhSach[TOI_DA]; int thuTu = 0;
	docFileTopping(fileTopping, danhSach, thuTu); inMenuTopping(danhSach, thuTu);
	cout << "Nhap MA topping muon xoa: "; string ma; getline(cin, ma);
	for (int i = 0; i < thuTu; i++) {
		if (danhSach[i].ma == ma) {
			if (xacNhan()) {
				for (int j = i; j < thuTu - 1; j++) danhSach[j] = danhSach[j + 1];
				thuTu--; ghiFileTopping(fileTopping, danhSach, thuTu);
				cout << "\n--> [THANH CONG] Da xoa!\n";
			}
			return;
		}
	}
	cout << "\n--> Khong tim thay ma!\n";
}
void suaTopping(string fileTopping) {
	veTieuDe("SUA TOPPING");
	Topping danhSach[TOI_DA]; int thuTu = 0;
	docFileTopping(fileTopping, danhSach, thuTu); inMenuTopping(danhSach, thuTu);
	cout << "Nhap MA topping muon sua: "; string ma; getline(cin, ma);
	for (int i = 0; i < thuTu; i++) {
		if (danhSach[i].ma == ma) {
			string buf;
			cout << format("Ten moi (cu: {}): ", danhSach[i].ten); getline(cin, buf); if (buf != "") danhSach[i].ten = buf;
			cout << format("Gia moi (cu: {}): ", danhSach[i].giaGoc); getline(cin, buf); if (buf != "") danhSach[i].giaGoc = stoi(buf);
			if (xacNhan()) {
				ghiFileTopping(fileTopping, danhSach, thuTu); cout << "\n--> [THANH CONG] Da cap nhat!\n";
			}
			return;
		}
	}
	cout << "\n--> Khong tim thay ma!\n";
}
void quanLiTopping() {
	while (true) {
		system("cls"); veTieuDe("[III] QUAN LI TOPPING");
		cout << "[1] Them\n[2] Xoa\n[3] Sua\n[0] Quay lai\n";
		veDuong(60); cout << " [*] CHON: ";
		string s; getline(cin, s); int c = (s == "") ? 0 : stoi(s);
		if (c == 0) break;
		system("cls");
		if (c == 1) themTopping("Topping.txt"); else if (c == 2) xoaTopping("Topping.txt"); else if (c == 3) suaTopping("Topping.txt");
		dungManHinh();
	}
}

// =========================================================
// 6. CẤU HÌNH ORDER (SIZE) (DOC/GHI/THEM/XOA/SUA)
// =========================================================
CauHinh docCauHinh(string thongTin) {
	istringstream phanTach(thongTin);
	CauHinh c; string boNhoDem;
	getline(phanTach, c.size, '|');
	getline(phanTach, boNhoDem); c.giaCongThem = stoi(boNhoDem);
	return c;
}
bool docFileCauHinh(string tenFile, CauHinh danhSach[], int& thuTu) {
	ifstream docFile(tenFile, ios::in);
	if (!docFile.is_open()) return false;
	string boNhoDem; thuTu = 0;
	while (getline(docFile, boNhoDem)) {
		if (boNhoDem.length() > 3) {
			danhSach[thuTu] = docCauHinh(boNhoDem);
			if (danhSach[thuTu].giaCongThem != 0) thuTu++;
		}
	}
	docFile.close(); return true;
}
bool ghiFileCauHinh(string tenFile, CauHinh danhSach[], int& thuTu) {
	ofstream ghiFile(tenFile, ios::out);
	if (!ghiFile.is_open()) return false;
	for (int i = 0; i < thuTu; i++) {
		ghiFile << danhSach[i].size << "|" << danhSach[i].giaCongThem << endl;
	}
	ghiFile.close(); return true;
}
void inCauHinh(CauHinh danhSach[], int& thuTu) {
	veDuong(40);
	cout << format("| {:<15} | {:<15} |", "SIZE", "GIA THEM") << endl;
	veDuong(40);
	for (int i = 0; i < thuTu; i++) {
		cout << format("| {:<15} | {:<15} |", danhSach[i].size, danhSach[i].giaCongThem) << endl;
	}
	veDuong(40); cout << endl;
}
void themSize(string fileCauHinh) {
	veTieuDe("THEM SIZE MOI");
	CauHinh danhSach[TOI_DA]; int thuTu = 0;
	docFileCauHinh(fileCauHinh, danhSach, thuTu); inCauHinh(danhSach, thuTu);
	CauHinh moi;
	cout << format("{:<25}: ", "Nhap ten size"); getline(cin, moi.size);
	cout << format("{:<25}: ", "Nhap gia them"); string s; getline(cin, s); moi.giaCongThem = (s == "") ? 0 : stoi(s);
	if (xacNhan()) {
		ofstream them(fileCauHinh, ios::app);
		them << moi.size << "|" << moi.giaCongThem << endl;
		them.close(); cout << "\n--> [THANH CONG] Da them!\n";
	}
}
void xoaSize(string fileCauHinh) {
	veTieuDe("XOA SIZE");
	CauHinh danhSach[TOI_DA]; int thuTu = 0;
	docFileCauHinh(fileCauHinh, danhSach, thuTu); inCauHinh(danhSach, thuTu);
	cout << "Nhap TEN size muon xoa: "; string ma; getline(cin, ma);
	for (int i = 0; i < thuTu; i++) {
		if (danhSach[i].size == ma) {
			if (xacNhan()) {
				for (int j = i; j < thuTu - 1; j++) danhSach[j] = danhSach[j + 1];
				thuTu--; ghiFileCauHinh(fileCauHinh, danhSach, thuTu);
				cout << "\n--> [THANH CONG] Da xoa!\n";
			}
			return;
		}
	}
	cout << "\n--> Khong tim thay!\n";
}
void cauHinhOrder() {
	while (true) {
		system("cls"); veTieuDe("[IV] CAU HINH ORDER");
		cout << "[1] Them Size\n[2] Xoa Size\n[0] Quay lai\n";
		veDuong(60); cout << " [*] CHON: ";
		string s; getline(cin, s); int c = (s == "") ? 0 : stoi(s);
		if (c == 0) break;
		system("cls");
		if (c == 1) themSize("CauHinhOrder.txt"); else if (c == 2) xoaSize("CauHinhOrder.txt");
		dungManHinh();
	}
}

// =========================================================
// 7. MENU CHI TIẾT
// =========================================================
void menuChiTiet() {
	DoUong du[TOI_DA]; int ndu = 0; docFileDoUong("DoUong.txt", du, ndu);
	DoAn da[TOI_DA]; int nda = 0; docFileDoAn("DoAn.txt", da, nda);
	Topping tp[TOI_DA]; int ntp = 0; docFileTopping("Topping.txt", tp, ntp);
	CauHinh ch[TOI_DA]; int nch = 0; docFileCauHinh("CauHinhOrder.txt", ch, nch);

	veTieuDe("MENU CHI TIET");
	cout << "\n--- DO UONG ---\n"; inMenuDoUong(du, ndu);
	cout << "\n--- DO AN ---\n"; inMenuDoAn(da, nda);
	cout << "\n--- TOPPING ---\n"; inMenuTopping(tp, ntp);
	cout << "\n--- SIZE ---\n"; inCauHinh(ch, nch);
}

// =========================================================
// 8. QUẢN LÝ BÀN & ORDER & THANH TOAN
// =========================================================
Ban docBan(string thongTin) {
	istringstream phanTach(thongTin);
	Ban b; string boNhoDem;
	getline(phanTach, boNhoDem, '|'); b.soBan = stoi(boNhoDem);
	getline(phanTach, boNhoDem); b.trangThai = stoi(boNhoDem);
	return b;
}
bool docFileBan(string tenFile, Ban dsBan[], int& soLuong) {
	ifstream docFile(tenFile, ios::in);
	if (!docFile.is_open()) return false;
	string boNhoDem; soLuong = 0;
	while (getline(docFile, boNhoDem)) {
		if (boNhoDem.length() < 1) continue;
		dsBan[soLuong] = docBan(boNhoDem);
		soLuong++;
	}
	docFile.close(); return true;
}
bool ghiFileBan(string tenFile, Ban dsBan[], int soLuong) {
	ofstream ghiFile(tenFile, ios::out);
	if (!ghiFile.is_open()) return false;
	for (int i = 0; i < soLuong; i++) {
		ghiFile << dsBan[i].soBan << "|" << dsBan[i].trangThai << endl;
	}
	ghiFile.close(); return true;
}
void inSoDoBan(Ban dsBan[], int soLuong) {
	veTieuDe("SO DO BAN");
	veDuong(60);
	for (int i = 0; i < soLuong; i++) {
		string trangThai = (dsBan[i].trangThai == 0) ? "Trong" : "CO KHACH";
		cout << format("[{:02} - {:<8}]", dsBan[i].soBan, trangThai);
		if ((i + 1) % 5 == 0) cout << endl;
	}
	veDuong(60);
}

void luuDoanhThu(HoaDon hd) {
	ofstream f("HoaDonDaThanhToan.txt", ios::app);
	if (f.is_open()) {
		f << "HD_START" << endl;
		f << format("{}|{}|{}|{}", hd.maHD, hd.ngay, hd.soBan, hd.tongTien) << endl;
		for (int i = 0; i < hd.soMon; i++) {
			ChiTietMon m = hd.dsMon[i];
			f << format("MON|{}|{}|{}|{}|{}", m.maMon, m.tenMon, m.giaGoc, m.soLuong, m.thanhTien) << endl;
			if (m.size != "S")
				f << format("SZ|SZ_{}|Size {}|{}|{}|{}", m.size, m.size, m.giaSize, m.soLuong, m.giaSize * m.soLuong) << endl;
			if (!m.topping.empty())
				f << format("TP|{}|{}|{}|{}|{}", m.maTopping, m.topping, m.giaTopping, m.soLuong, m.giaTopping * m.soLuong) << endl;
		}
		f << "HD_END" << endl;
		f.close();
	}
}

void xuatBillChoKhach(HoaDon hd) {
	string tenFile = "PhieuInHoaDon.txt";
	ofstream f(tenFile);
	if (f.is_open()) {
		f << "==================================================" << endl;
		f << "              CUA HANG CA PHE ABC                 " << endl;
		f << "==================================================" << endl;
		f << format(" SO HD: {:<18} NGAY: {:<10}", hd.maHD, hd.ngay) << endl;
		f << format(" BAN:   {:<18}", (hd.soBan == 0 ? "Mang Ve" : to_string(hd.soBan))) << endl;
		f << "--------------------------------------------------" << endl;
		f << format(" {:<28} {:^4} {:>14} ", "TEN", "SL", "THANH TIEN") << endl;
		f << "--------------------------------------------------" << endl;
		for (int i = 0; i < hd.soMon; i++) {
			ChiTietMon m = hd.dsMon[i];
			f << format(" {:<28} {:^4} {:>14} ", m.tenMon, m.soLuong, m.giaGoc * m.soLuong) << endl;
			if (m.size != "S") f << format(" {:<28} {:^4} {:>14} ", " + Size " + m.size, "", m.giaSize * m.soLuong) << endl;
			if (!m.topping.empty()) f << format(" {:<28} {:^4} {:>14} ", " + " + m.topping, "", m.giaTopping * m.soLuong) << endl;
		}
		f << "--------------------------------------------------" << endl;
		f << format(" TONG CONG: {:>36} VND ", hd.tongTien) << endl;
		f << "==================================================" << endl;
		f.close();
		string lenh = "notepad.exe " + tenFile;
		system(lenh.c_str());
	}
}

void taoOrderMoi() {
	// 1. Load Data
	Ban dsBan[TOI_DA]; int slBan = 0; docFileBan("Ban.txt", dsBan, slBan);
	DoUong dsDU[TOI_DA]; int slDU = 0; docFileDoUong("DoUong.txt", dsDU, slDU);
	DoAn dsDA[TOI_DA]; int slDA = 0; docFileDoAn("DoAn.txt", dsDA, slDA);
	Topping dsTop[TOI_DA]; int slTop = 0; docFileTopping("Topping.txt", dsTop, slTop);
	CauHinh dsSize[TOI_DA]; int slSize = 0; docFileCauHinh("CauHinhOrder.txt", dsSize, slSize);

	// Gộp menu
	MonMenu menu[200]; int slMenu = 0;
	for (int i = 0; i < slDU; i++) menu[slMenu++] = { dsDU[i].ma, dsDU[i].ten, "Do Uong", dsDU[i].giaGoc };
	for (int i = 0; i < slDA; i++) menu[slMenu++] = { dsDA[i].ma, dsDA[i].ten, "Do An", dsDA[i].giaGoc };

	veTieuDe("ORDER TAI QUAY");
	inSoDoBan(dsBan, slBan);

	HoaDon hd;
	cout << "--> So ban (0 = Mang ve): "; string sban; getline(cin, sban);
	hd.soBan = (sban == "") ? 0 : stoi(sban);

	if (hd.soBan != 0) {
		for (int i = 0; i < slBan; i++) {
			if (dsBan[i].soBan == hd.soBan && dsBan[i].trangThai == 1) {
				cout << "[!] Ban dang co khach. Tiep tuc ghi them mon? (Y/N) ";
				if (!xacNhan()) return;
			}
		}
	}

	hd.maHD = "HD" + to_string(time(0));
	hd.ngay = layNgayHienTai();
	hd.soMon = 0; hd.tongTien = 0;

	while (true) {
		system("cls");
		veTieuDe(format("BAN {} - TONG: {} VND", hd.soBan, hd.tongTien));
		cout << format("| {:<10} | {:<30} | {:<10} |", "MA", "TEN", "GIA") << endl;
		veDuong(58);
		for (int i = 0; i < slMenu; i++) cout << format("| {:<10} | {:<30} | {:<10} |", menu[i].ma, menu[i].ten, menu[i].gia) << endl;
		veDuong(58);

		cout << "\n--> Nhap MA (0 Thanh Toan): "; string ma; getline(cin, ma);
		if (ma == "0") break;

		bool found = false; MonMenu m;
		for (int i = 0; i < slMenu; i++) if (menu[i].ma == ma) { m = menu[i]; found = true; break; }

		if (found) {
			ChiTietMon ct; ct.maMon = m.ma; ct.tenMon = m.ten; ct.giaGoc = m.gia;
			cout << "--> So Luong: "; string ssl; getline(cin, ssl);
			ct.soLuong = (ssl == "") ? 0 : stoi(ssl);
			if (ct.soLuong <= 0) continue;

			// Default values
			ct.size = "S"; ct.giaSize = 0; ct.topping = ""; ct.giaTopping = 0;

			if (m.loai == "Do Uong") {
				// Chon Size
				cout << "\n-- SIZE: ";
				for (int k = 0; k < slSize; k++) cout << format("{} (+{}) | ", dsSize[k].size, dsSize[k].giaCongThem);
				cout << "\n--> Nhap ten Size (Enter = S): "; string sz; getline(cin, sz);
				if (sz != "") {
					for (auto& c : sz) c = toupper(c);
					for (int k = 0; k < slSize; k++) if (dsSize[k].size == sz) {
						ct.size = sz; ct.giaSize = dsSize[k].giaCongThem; break;
					}
				}
				// Chon Topping
				cout << "\n-- TOPPING: ";
				for (int k = 0; k < slTop; k++) cout << format("{} (+{}) | ", dsTop[k].ma, dsTop[k].giaGoc);
				cout << "\n--> Nhap MA Top (Enter = Khong): "; string mt; getline(cin, mt);
				if (mt != "") {
					for (int k = 0; k < slTop; k++) if (dsTop[k].ma == mt) {
						ct.topping = dsTop[k].ten; ct.maTopping = dsTop[k].ma; ct.giaTopping = dsTop[k].giaGoc; break;
					}
				}
			}

			ct.thanhTien = (ct.giaGoc + ct.giaSize + ct.giaTopping) * ct.soLuong;
			hd.dsMon[hd.soMon++] = ct;
			hd.tongTien += ct.thanhTien;
		}
		else {
			cout << "(!) Khong tim thay ma mon!\n"; dungManHinh();
		}
	}

	if (hd.soMon > 0) {
		cout << "\n--> TONG: " << hd.tongTien << ". Khach dua: ";
		string stk; getline(cin, stk);
		int tienKhach = (stk == "") ? 0 : stoi(stk);

		if (tienKhach >= hd.tongTien) {
			cout << "--> Tien thoi: " << tienKhach - hd.tongTien << endl;
			if (xacNhan()) {
				luuDoanhThu(hd); xuatBillChoKhach(hd);
				if (hd.soBan != 0) {
					for (int i = 0; i < slBan; i++) if (dsBan[i].soBan == hd.soBan) dsBan[i].trangThai = 1;
					ghiFileBan("Ban.txt", dsBan, slBan);
				}
				cout << "--> GIAO DICH THANH CONG!\n";
			}
		}
		else {
			cout << "--> Khach dua thieu tien! Huy giao dich.\n";
		}
	}
}

void donBan() {
	Ban ds[TOI_DA]; int n; docFileBan("Ban.txt", ds, n); inSoDoBan(ds, n);
	cout << "--> Nhap ban don (0 thoat): "; string sb; getline(cin, sb);
	int b = (sb == "") ? 0 : stoi(sb);
	if (b != 0) {
		bool timThay = false;
		for (int i = 0; i < n; i++) if (ds[i].soBan == b) {
			ds[i].trangThai = 0; timThay = true;
		}
		if (timThay) {
			ghiFileBan("Ban.txt", ds, n); cout << "--> Da don ban " << b << "!\n";
		}
		else cout << "--> Khong tim thay ban!\n";
	}
}

void inLaiHoaDonCu() {
	cout << "Chuc nang dang duoc bao tri.\n";
}

void quanLiBanHangVaOrder() {
	while (true) {
		system("cls"); veTieuDe("QUAN LY BAN HANG");
		cout << "[1] Order & Pay\n[2] Don ban\n[3] So do ban\n[4] In lai Bill cu\n[0] Ve\nChon: ";
		string sc; getline(cin, sc);
		int c = (sc == "") ? 0 : stoi(sc);
		if (c == 0) break;
		if (c == 1) taoOrderMoi();
		else if (c == 2) donBan();
		else if (c == 4) inLaiHoaDonCu();
		else if (c == 3) { Ban ds[100]; int n; docFileBan("Ban.txt", ds, n); inSoDoBan(ds, n); dungManHinh(); }
	}
}

// =========================================================
// 9. BÁO CÁO THỐNG KÊ (DOC HOA DON & TINH TOAN)
// =========================================================
ChiTietMon docChiTietMonTuFile(string line) {
	ChiTietMon m;
	m.maMon = tachData(line, 1);
	m.tenMon = tachData(line, 2);
	m.giaGoc = stoi(tachData(line, 3));
	m.soLuong = stoi(tachData(line, 4));
	m.thanhTien = stoi(tachData(line, 5));
	return m;
}

bool docFileHoaDon(string tenFile, HoaDon dsHD[], int& soLuong) {
	ifstream f(tenFile);
	if (!f.is_open()) return false;
	
	string line; soLuong = 0;
	while (getline(f, line)) {
		if (line.find("HD_START") != string::npos) {
			if (getline(f, line)) {
				dsHD[soLuong].maHD = tachData(line, 0);
				dsHD[soLuong].ngay = tachData(line, 1);
				string sb = tachData(line, 2);
				dsHD[soLuong].soBan = stoi(sb);
				dsHD[soLuong].tongTien = stoi(tachData(line, 3));
				dsHD[soLuong].soMon = 0;
				while (getline(f, line)) {
					if (line.find("HD_END") != string::npos) break;
					if (line.find("MON|") == 0) {
						dsHD[soLuong].dsMon[dsHD[soLuong].soMon] = docChiTietMonTuFile(line);
						dsHD[soLuong].soMon++;
					}
				}
				soLuong++;
			}
		}
	}
	f.close(); return true;
}

void thongKeBanHang() {
	system("cls"); veTieuDe("THONG KE DOANH THU");
	HoaDon dsHD[TOI_DA]; int n = 0;
	if (!docFileHoaDon("HoaDonDaThanhToan.txt", dsHD, n) || n == 0) {
		cout << "--> Chua co du lieu hoa don!\n"; dungManHinh(); return;
	}

	long long tongDoanhThu = 0;
	int tongMon = 0;

	veDuong(75);
	cout << format("| {:<15} | {:<12} | {:<10} | {:<15} | {:<8} |", "MA HD", "NGAY", "BAN", "TONG TIEN", "SO MON") << endl;
	veDuong(75);
	for (int i = 0; i < n; i++) {
		cout << format("| {:<15} | {:<12} | {:<10} | {:<15} | {:<8} |",
			dsHD[i].maHD, dsHD[i].ngay, dsHD[i].soBan, dsHD[i].tongTien, dsHD[i].soMon) << endl;
		tongDoanhThu += dsHD[i].tongTien;
		tongMon += dsHD[i].soMon;
	}
	veDuong(75);
	cout << "\n=== TONG KET ===\n";
	cout << format(" - Tong so hoa don:  {}\n", n);
	cout << format(" - Tong so mon ban:  {}\n", tongMon);
	cout << format(" - TONG DOANH THU:   {} VND\n", tongDoanhThu);
	dungManHinh();
}

void thongKeMonBanChay() {
	system("cls"); veTieuDe("TOP MON BAN CHAY");
	HoaDon dsHD[TOI_DA]; int n = 0;
	if (!docFileHoaDon("HoaDonDaThanhToan.txt", dsHD, n) || n == 0) {
		cout << "--> Chua co du lieu hoa don!\n"; dungManHinh(); return;
	}

	string tenMon[TOI_DA];
	int slBan[TOI_DA] = { 0 };
	int soLuongMenu = 0;

	for (int i = 0; i < n; i++) {
		for (int j = 0; j < dsHD[i].soMon; j++) {
			string tenHienTai = dsHD[i].dsMon[j].tenMon;
			int slHienTai = dsHD[i].dsMon[j].soLuong;
			bool daCo = false;
			for (int k = 0; k < soLuongMenu; k++) {
				if (tenMon[k] == tenHienTai) {
					slBan[k] += slHienTai; daCo = true; break;
				}
			}
			if (!daCo) {
				tenMon[soLuongMenu] = tenHienTai;
				slBan[soLuongMenu] = slHienTai;
				soLuongMenu++;
			}
		}
	}

	for (int i = 0; i < soLuongMenu - 1; i++) {
		for (int j = i + 1; j < soLuongMenu; j++) {
			if (slBan[i] < slBan[j]) {
				int tempSL = slBan[i]; slBan[i] = slBan[j]; slBan[j] = tempSL;
				string tempTen = tenMon[i]; tenMon[i] = tenMon[j]; tenMon[j] = tempTen;
			}
		}
	}

	veDuong(60);
	cout << format("| {:<5} | {:<35} | {:<10} |", "TOP", "TEN MON", "DA BAN") << endl;
	veDuong(60);
	for (int i = 0; i < soLuongMenu; i++) {
		cout << format("| {:<5} | {:<35} | {:<10} |", i + 1, tenMon[i], slBan[i]) << endl;
	}
	veDuong(60); dungManHinh();
}

void baoCaoThongKe() {
	while (true) {
		system("cls"); veTieuDe("[III] BAO CAO THONG KE");
		cout << "[1] Thong ke doanh thu\n[2] Thong ke mon ban chay\n[0] Quay lai\n";
		veDuong(60); cout << " [*] CHON: ";
		string s; getline(cin, s); int c = (s == "") ? 0 : stoi(s);
		if (c == 0) break;
		if (c == 1) thongKeBanHang();
		else if (c == 2) thongKeMonBanChay();
		else cout << "\n--> Lua chon khong hop le!" << endl;
	}
}

// =========================================================
// 10. MENU CHÍNH & MAIN
// =========================================================
void quanLiCoSoDuLieu() {
	while (true) {
		system("cls"); veTieuDe("[I] QUAN LI CO SO DU LIEU");
		cout << "[1] Quan li do uong\n[2] Quan li do an\n[3] Quan li topping\n[4] Cau hinh order\n[5] Menu chi tiet\n[0] Quay lai\n";
		veDuong(60); cout << " [*] CHON: ";
		string s; getline(cin, s); int c = (s == "") ? 0 : stoi(s);
		if (c == 0) break;
		system("cls");
		if (c == 1) quanLiDoUong();
		else if (c == 2) quanLiDoAn();
		else if (c == 3) quanLiTopping();
		else if (c == 4) cauHinhOrder();
		else if (c == 5) menuChiTiet();
		dungManHinh();
	}
}

void quanLiDuLieuPhatSinh() {
	while (true) {
		system("cls"); veTieuDe("[II] QUAN LI DU LIEU PHAT SINH");
		cout << "[1] Quan li ban hang va order\n[0] Quay lai\n";
		veDuong(60); cout << " [*] CHON: ";
		string s; getline(cin, s); int c = (s == "") ? 0 : stoi(s);
		if (c == 0) break;
		if (c == 1) quanLiBanHangVaOrder();
		else cout << "\n--> Chuc nang dang phat trien!\n";
		dungManHinh();
	}
}

int main() {
	while (true) {
		system("cls"); veTieuDe("CUA HANG CA PHE");
		cout << "[1] QUAN LI CO SO DU LIEU\n[2] QUAN LI DU LIEU PHAT SINH\n[3] BAO CAO THONG KE\n[0] THOAT\n";
		veDuong(60); cout << " [*] CHON: ";
		string s; getline(cin, s); int c = (s == "") ? 0 : stoi(s);
		if (c == 0) break;
		if (c == 1) quanLiCoSoDuLieu();
		else if (c == 2) quanLiDuLieuPhatSinh();
		else if (c == 3) baoCaoThongKe();
		dungManHinh();
	}
	return 0;
}
